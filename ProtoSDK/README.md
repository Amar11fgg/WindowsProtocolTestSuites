# Instrumentation Notes
Instrumentation is done using the [Event Source](https://learn.microsoft.com/en-us/dotnet/core/diagnostics/eventsource-getting-started) library to allow for log subscriptions from ETW, EventPipe and other subscribers.

The convention in use here is to have one event source provider/class per protocol. The reason for this is to make it convenient to filter for traces using the protocol name since the defualt filtering options for collected traces seem to be mostly limited to using the event source name e.g. we can use *dotnet-trace collect --providers Microsoft-WindowsProtocolsTestSuite-Kerberos --process-id 1234* to restrict the collected traces for the process 1234 to the Kerberos Test Suite library. The Event Source library recommendation is to use event source names that can be globally unique. In this case, we're prefixing with *Microsoft-WindowsProtocolsTestSuite-* to achieve this.

For each protocol class method that needs to be instrumented within the protocol library, we can use the convention, *ClassNameOrAbbreviation_MethodName+Action* e.g. *ClientSecurityContext_InitializationWithServerTokenStarted*. Instrumentation calls can be added at the beginning and at the end of each selected method. For each class, blocks of event ids e.g. 100-200 can be allocated so that the instrumentation methods for that class can follow each other sequentially within the event source provider/class where possible. Event ids of 1-20 can be reserved for instrumenting constructors. The maximum value of the id parameter is [65,535](https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.eventlogtracelistener.tracedata?view=dotnet-plat-ext-8.0). 

The preference is to use primitives and collections of primitives as parameters to the event source provider/class methods wherever possible. Where not possible, the parameter class/type needs to be decorated with the *[EventData]* attribute to allow for effective serialization out of the running process.

More details on the Event Source library, including how to use the *dotnet-trace* tool to collect traces from a starting process using the executable name or from a running process process using the process id can be found [here](https://learn.microsoft.com/en-us/dotnet/core/diagnostics/eventsource-collect-and-view-traces) and [here](https://learn.microsoft.com/en-us/dotnet/core/diagnostics/dotnet-trace#dotnet-trace-collect).
